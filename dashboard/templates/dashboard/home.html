{% extends "orcamet_portal/base.html" %}

{% block title %}Dashboard â€” OrcaMet Portal{% endblock %}

{% block content %}
<div class="dashboard">
    <div class="dashboard-header">
        <h1>Welcome, {{ user.first_name|default:user.username }}</h1>
        <p class="dashboard-role">
            {% if user.is_superadmin %}
                OrcaMet Administrator â€” All clients
            {% elif user.client %}
                {{ user.client.name }}
                {% if user.is_client_admin %}(Admin){% endif %}
            {% endif %}
        </p>
    </div>

    <div class="dashboard-stats">
        <div class="stat-card">
            <div class="stat-number">{{ site_count }}</div>
            <div class="stat-label">Active Sites</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ forecast_count }}</div>
            <div class="stat-label">Sites with Forecasts</div>
        </div>
        <div class="stat-card {% if alert_count > 0 %}stat-card-alert{% endif %}">
            <div class="stat-number">{{ alert_count }}</div>
            <div class="stat-label">Active Alerts</div>
        </div>
        <div class="stat-card">
            <div class="stat-number stat-time">
                {% if latest_forecast_time %}
                    {{ latest_forecast_time|date:"H:i" }}
                {% else %}
                    â€”
                {% endif %}
            </div>
            <div class="stat-label">
                {% if latest_forecast_time %}
                    Last Update {{ latest_forecast_time|date:"d M" }}
                {% else %}
                    No Forecasts Yet
                {% endif %}
            </div>
        </div>
    </div>

    <div class="section">
        <h2>Your Sites</h2>

        {% if sites %}
        <div class="table-responsive">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Site Name</th>
                    {% if user.is_superadmin %}<th>Client</th>{% endif %}
                    <th>Postcode</th>
                    <th>Exposure</th>
                    <th>Status</th>
                    <th>Today's Risk</th>
                    <th>Recommendation</th>
                    <th>Peak Wind</th>
                    <th>Peak Gust</th>
                </tr>
            </thead>
            <tbody>
                {% for site in sites %}
                <tr class="site-row" onclick="window.location='{% url 'dashboard:site_detail' site.pk %}'">
                    <td><strong><a href="{% url 'dashboard:site_detail' site.pk %}">{{ site.name }}</a></strong></td>
                    {% if user.is_superadmin %}<td>{{ site.client.name }}</td>{% endif %}
                    <td>{{ site.postcode }}</td>
                    <td>{{ site.get_exposure_display }}</td>
                    <td>
                        {% if site.job_complete %}
                            <span class="badge badge-muted">Complete</span>
                        {% else %}
                            <span class="badge badge-active">Active</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if site.latest_run %}
                            {% with risk=site.latest_run.peak_risk %}
                                {% if risk < 20 %}
                                    <span class="risk-bar risk-low" style="--risk-width: {{ risk }}%">{{ risk|floatformat:0 }}%</span>
                                {% elif risk < 50 %}
                                    <span class="risk-bar risk-medium" style="--risk-width: {{ risk }}%">{{ risk|floatformat:0 }}%</span>
                                {% else %}
                                    <span class="risk-bar risk-high" style="--risk-width: {{ risk }}%">{{ risk|floatformat:0 }}%</span>
                                {% endif %}
                            {% endwith %}
                        {% else %}
                            <span class="badge badge-pending">Awaiting</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if site.latest_run %}
                            {% if site.latest_run.recommendation == "GO" %}
                                <span class="badge badge-active">ðŸŸ¢ GO</span>
                            {% elif site.latest_run.recommendation == "CAUTION" %}
                                <span class="badge badge-caution">ðŸŸ¡ CAUTION</span>
                            {% elif site.latest_run.recommendation == "CANCEL" %}
                                <span class="badge badge-cancel">ðŸ”´ CANCEL</span>
                            {% else %}
                                <span class="badge badge-muted">{{ site.latest_run.recommendation }}</span>
                            {% endif %}
                        {% else %}
                            <span class="badge badge-muted">â€”</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if site.latest_run and site.latest_run.peak_wind is not None %}
                            {{ site.latest_run.peak_wind|floatformat:1 }} m/s
                        {% else %}â€”{% endif %}
                    </td>
                    <td>
                        {% if site.latest_run and site.latest_run.peak_gust is not None %}
                            {{ site.latest_run.peak_gust|floatformat:1 }} m/s
                        {% else %}â€”{% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        </div>
        {% else %}
        <div class="empty-state">
            <p>No active sites found.</p>
            {% if user.is_superadmin %}
            <p>Head to the <a href="/admin/sites/site/add/">Admin panel</a> to add sites.</p>
            {% else %}
            <p>Contact your OrcaMet account manager to have sites added.</p>
            {% endif %}
        </div>
        {% endif %}
    </div>

    {% if user.is_superadmin %}
    <div class="section">
        <h2>Admin Actions</h2>
        <div class="admin-actions">
            <a href="/admin/" class="btn btn-primary">Django Admin</a>
            <a href="/admin/sites/site/add/" class="btn btn-secondary">Add Site</a>
            <a href="/admin/sites/client/add/" class="btn btn-secondary">Add Client</a>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}
